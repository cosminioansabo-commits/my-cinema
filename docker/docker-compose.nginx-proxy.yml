# =============================================================================
# NGINX REVERSE PROXY + CERTBOT (Let's Encrypt)
# =============================================================================
# HTTPS termination for all My Cinema services
#
# Initial setup (run ONCE to get certificates):
#   1. Ensure ports 80 and 443 are forwarded to NAS
#   2. Start nginx with HTTP-only mode first:
#      docker compose -f docker-compose.nginx-proxy.yml up -d nginx-proxy
#   3. Issue initial certificate:
#      docker compose -f docker-compose.nginx-proxy.yml run --rm certbot \
#        certonly --webroot -w /var/www/certbot \
#        --email your-email@example.com \
#        -d co-sa-srv.go.ro --agree-tos --no-eff-email
#   4. Restart nginx to load the certificate:
#      docker compose -f docker-compose.nginx-proxy.yml restart nginx-proxy
#
# Certificate renewal (automatic via cron or manual):
#   docker compose -f docker-compose.nginx-proxy.yml run --rm certbot renew
#   docker compose -f docker-compose.nginx-proxy.yml exec nginx-proxy nginx -s reload
#
# Usage:
#   docker compose -f docker-compose.nginx-proxy.yml up -d
#
# Access:
#   https://co-sa-srv.go.ro
# =============================================================================

services:
  nginx-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../nginx/reverse-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ../nginx/ssl.conf:/etc/nginx/ssl.conf.available:ro
      - certbot-certs:/etc/letsencrypt:ro
      - certbot-webroot:/var/www/certbot:ro
    # Auto-detect SSL certs: if they exist, enable HTTPS; otherwise HTTP-only
    entrypoint: /bin/sh -c 'if [ -f /etc/letsencrypt/live/co-sa-srv.go.ro/fullchain.pem ]; then cp /etc/nginx/ssl.conf.available /etc/nginx/conf.d/ssl.conf; echo "SSL certs found - HTTPS enabled"; else echo "No SSL certs yet - HTTP-only mode"; fi && exec nginx -g "daemon off;"'
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    volumes:
      - certbot-certs:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot
    # Runs once and exits; use `docker compose run --rm certbot renew` for renewal
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot; sleep 12h & wait $${!}; done'"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

volumes:
  certbot-certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /volume2/docker/nginx-proxy/certs
  certbot-webroot:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /volume2/docker/nginx-proxy/webroot

networks:
  default:
    name: my-cinema-network
    external: true
