# =============================================================================
# MY-CINEMA APP
# =============================================================================
# Frontend + Backend deployment
#
# Prerequisites:
#   1. All other services running (prowlarr, radarr, sonarr, qbittorrent, jellyfin)
#   2. Login to GitHub Container Registry:
#      echo "YOUR_GITHUB_TOKEN" | docker login ghcr.io -u YOUR_USERNAME --password-stdin
#   3. Create .env file from .env.my-cinema.example
#
# Usage:
#   docker compose -f docker-compose.my-cinema.yml up -d
#
# Access:
#   Local:  http://NAS_IP:8081
#   Remote: http://your-domain:8081 (requires port forwarding)
#
# For remote video playback, also forward port 8096 (Jellyfin)
# =============================================================================

services:
  my-cinema-frontend:
    image: ghcr.io/${GITHUB_USERNAME}/my-cinema-frontend:latest
    container_name: my-cinema-frontend
    restart: unless-stopped
    ports:
      - "8081:80"
    depends_on:
      - my-cinema-backend
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  my-cinema-backend:
    image: ghcr.io/${GITHUB_USERNAME}/my-cinema-backend:latest
    container_name: my-cinema-backend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      # Server
      - PORT=3001
      - CORS_ORIGIN=http://${NAS_IP}
      - DOWNLOAD_PATH=/data/downloads
      - BACKEND_EXTERNAL_URL=${BACKEND_EXTERNAL_URL:-http://${NAS_IP}:3001}
      # Torrent services (use container names)
      - PROWLARR_URL=http://prowlarr:9696
      - PROWLARR_API_KEY=${PROWLARR_API_KEY}
      - QBITTORRENT_URL=http://qbittorrent:8080
      - QBITTORRENT_USERNAME=${QBITTORRENT_USERNAME}
      - QBITTORRENT_PASSWORD=${QBITTORRENT_PASSWORD}
      - SEARCH_PROVIDERS=${SEARCH_PROVIDERS:-prowlarr}
      # Media library services (use container names)
      - RADARR_URL=http://radarr:7878
      - RADARR_API_KEY=${RADARR_API_KEY}
      - SONARR_URL=http://sonarr:8989
      - SONARR_API_KEY=${SONARR_API_KEY}
      # Jellyfin (use container name for internal, external URL for browser access)
      - JELLYFIN_URL=http://jellyfin:8096
      - JELLYFIN_EXTERNAL_URL=${JELLYFIN_EXTERNAL_URL}
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY}
      # Authentication
      - JWT_SECRET=${JWT_SECRET}
      - APP_PASSWORD_HASH=${APP_PASSWORD_HASH}
      - TOKEN_EXPIRY=7d
      # OpenSubtitles (optional)
      - OPENSUBTITLES_API_KEY=${OPENSUBTITLES_API_KEY:-}
      - OPENSUBTITLES_USERNAME=${OPENSUBTITLES_USERNAME:-}
      - OPENSUBTITLES_PASSWORD=${OPENSUBTITLES_PASSWORD:-}
    volumes:
      - /volume1/data:/data
    devices:
      - /dev/dri:/dev/dri
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

networks:
  default:
    name: my-cinema-network
