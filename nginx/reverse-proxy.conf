# =============================================================================
# Nginx Reverse Proxy Configuration
# =============================================================================
# Routes all My Cinema traffic through a single HTTPS entry point.
#
# Routing:
#   /                  -> my-cinema-frontend:80  (Vue SPA)
#   /api/              -> my-cinema-backend:3001 (Express API)
#   /ws                -> my-cinema-backend:3001 (WebSocket)
#
# First run: Nginx starts HTTP-only (port 80) for Let's Encrypt challenge.
# After certs are issued, restart nginx to enable HTTPS (port 443).
# The SSL server block uses a conditional check so nginx doesn't crash
# when certificate files don't exist yet.
# =============================================================================

# WebSocket upgrade map
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Rate limiting zone for API
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

# HTTP server (always active — handles ACME challenge + redirect)
server {
    listen 80;
    server_name co-sa-srv.go.ro;

    # Let's Encrypt HTTP-01 challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS server — only loads if certificate files exist
# On first run (no certs yet), nginx skips this block and runs HTTP-only.
# After certbot issues certs, restart nginx to activate HTTPS.
include /etc/nginx/conf.d/ssl.conf*;
